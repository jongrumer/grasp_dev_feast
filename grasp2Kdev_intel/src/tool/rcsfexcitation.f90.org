!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!
! RCSFEXCITATION
!
! This program generates excitation input to rcsfgenerate
!
! Per Jonsson, Malmo University, October 2013
!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

program rcsfexcitation
implicit none
integer            :: i,k,j,nmax,lmax,mr,n(15),l(15),occ(15),nr,lr,occr,nl(0:15)
integer            :: jmin,jmax,nexc,occupied,ncore,nstart(0:6),lstart(0:6)
integer            :: nc(30),lc(30),ncoreloop,nclose,norbitalstring
integer            :: conflength,norb,orblength(15),orbstart(0:15),flag(15),nfound
integer            :: number1,number2,norbstrings,orbstring_l(11),orbstring_n(11)
integer            :: ncoreorbitals,lmaxcore

character(len=1)   :: lstring,ans
character(len=2)   :: sel(15)
character(len=135) :: config
character(len=135) :: configvect(100)
character(len=44)  :: orbitalstring
character(len=11)  :: decoding
character(len=3)   :: orbital(11)


!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

decoding = 'spdfghiklmn'

open(11, file='excitationdata',status='unknown',form='formatted')
open(12, file='rcsfexcitation.log',status='unknown',form='formatted')

! Generate initial input to jjgen

! New list
write(11,'(a)') '*'

! Default symmetry
write(11,'(a)') '*'

n = 0
l = 0
occ = 0
nc = 0
lc = 0

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

write(*,*) 
write(*,*) 'RCSFEXCITATION'
write(*,*) 'This program creates excitation input to RCSFGENERATE'
write(*,*) 'Configurations should be entered in spectroscopic notation'
write(*,*) 'with occupation numbers and indications if orbitals are'
write(*,*) 'closed (c), inactive (i), active (*) or has a minimal'
write(*,*) 'occupation e.g. 1s(2,1)2s(2,*)'
write(*,*) 'Outputfiles: excitationdata, rcsfexcitation.log'
write(*,*) 
write(*,*) 'Select core '
write(*,*) '       0: No core'
write(*,*) '       1: He (       1s(2)                  =  2 electrons)'
write(*,*) '       2: Ne ([He] + 2s(2)2p(6)             = 10 electrons)'
write(*,*) '       3: Ar ([Ne] + 3s(2)3p(6)             = 18 electrons)'
write(*,*) '       4: Kr ([Ar] + 3d(10)4s(2)4p(6)       = 36 electrons)'
write(*,*) '       5: Xe ([Kr] + 4d(10)5s(2)5p(6)       = 54 electrons)'
write(*,*) '       6: Rn ([Xe] + 4f(14)5d(10)6s(2)6p(6) = 86 electrons)'
read(*,*) ncore
write(12,*) ncore, ' ! Selected core'

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

! Analyze core and define the orbitals in the core

select case(ncore)
   case(1)
      ncoreorbitals = 1   ! 1 core orbital
      lmaxcore = 0        ! 
      nc(1) = 1           ! 1s
      lc(1) = 0           ! 1s
   case(2)
      ncoreorbitals = 3   ! 3  core orbitals
      lmaxcore = 1        ! 
      nc(1) = 1           ! 1s
      lc(1) = 0           ! 1s
      nc(2) = 2           ! 2s
      lc(2) = 0           ! 2s
      nc(3) = 2           ! 2p
      lc(3) = 1           ! 2p
   case(3)
      ncoreorbitals = 5   ! 5 core orbitals
      lmaxcore = 1        ! 
      nc(1) = 1           ! 1s
      lc(1) = 0           ! 1s
      nc(2) = 2           ! 2s
      lc(2) = 0           ! 2s
      nc(3) = 2           ! 2p
      lc(3) = 1           ! 2p
      nc(4) = 3           ! 3s
      lc(4) = 0           ! 3s
      nc(5) = 3           ! 3p
      lc(5) = 1           ! 3p
   case(4)
      ncoreorbitals = 8   ! 8 core orbitals
      lmaxcore = 2        ! 
      nc(1) = 1           ! 1s
      lc(1) = 0           ! 1s
      nc(2) = 2           ! 2s
      lc(2) = 0           ! 2s
      nc(3) = 2           ! 2p
      lc(3) = 1           ! 2p
      nc(4) = 3           ! 3s
      lc(4) = 0           ! 3s
      nc(5) = 3           ! 3p
      lc(5) = 1           ! 3p
      nc(6) = 3           ! 3d
      lc(6) = 2           ! 3d
      nc(7) = 4           ! 4s
      lc(7) = 0           ! 4s
      nc(8) = 4           ! 4p
      lc(8) = 1           ! 4p
   case(5)
      ncoreorbitals = 11  ! 11 core orbitals
      lmaxcore = 2        ! 
      nc(1) = 1           ! 1s
      lc(1) = 0           ! 1s
      nc(2) = 2           ! 2s
      lc(2) = 0           ! 2s
      nc(3) = 2           ! 2p
      lc(3) = 1           ! 2p
      nc(4) = 3           ! 3s
      lc(4) = 0           ! 3s
      nc(5) = 3           ! 3p
      lc(5) = 1           ! 3p
      nc(6) = 3           ! 3d
      lc(6) = 2           ! 3d
      nc(7) = 4           ! 4s
      lc(7) = 0           ! 4s
      nc(8) = 4           ! 4p
      lc(8) = 1           ! 4p
      nc(9) = 4           ! 4d
      lc(9) = 2           ! 4d
      nc(10) = 5          ! 5s
      lc(10) = 0          ! 5s
      nc(11) = 5          ! 5p
      lc(11) = 1          ! 5p
   case(6)
      ncoreorbitals = 15  ! 15 core orbitals
      lmaxcore = 3        ! 
      nc(1) = 1           ! 1s
      lc(1) = 0           ! 1s
      nc(2) = 2           ! 2s
      lc(2) = 0           ! 2s
      nc(3) = 2           ! 2p
      lc(3) = 1           ! 2p
      nc(4) = 3           ! 3s
      lc(4) = 0           ! 3s
      nc(5) = 3           ! 3p
      lc(5) = 1           ! 3p
      nc(6) = 3           ! 3d
      lc(6) = 2           ! 3d
      nc(7) = 4           ! 4s
      lc(7) = 0           ! 4s
      nc(8) = 4           ! 4p
      lc(8) = 1           ! 4p
      nc(9) = 4           ! 4d
      lc(9) = 2           ! 4d
      nc(10) = 5          ! 5s
      lc(10) = 0          ! 5s
      nc(11) = 5          ! 5p
      lc(11) = 1          ! 5p
      nc(12) = 4          ! 4f
      lc(12) = 3          ! 4f
      nc(13) = 5          ! 5d
      lc(13) = 2          ! 5d
      nc(14) = 6          ! 6s
      lc(14) = 0          ! 6s
      nc(15) = 6          ! 6p
      lc(15) = 1          ! 6p
end select

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!


! Input the mutirefernce for later processing

write(*,*) 'Number of reference configurations '
read(*,*) mr
write(12,*) mr, ' ! Number of reference configurations'
if (mr.gt.100) then
   write(*,*) 'No more than 100 reference configurations '
   stop
end if

do j = 1,mr

10 continue
   write(*,*) 'Give configuration', j
   read(*,'(a)') configvect(j)
   write(12,'(a)') trim(configvect(j))

!  Initial check, each orbital need to be closed, inactive, or minimal

   conflength = len(trim(configvect(j)))
   number1 = 0
   number2 = 0
   do k = 1,conflength
      if (configvect(j)(k:k).eq.'(') number1 = number1 + 1 
      if (configvect(j)(k:k).eq.',') number2 = number2 + 1 
   end do
   if (number1.ne.number2) then
      write(*,*)  'Each orbital must be closed (c), inactive (i), active (*)'
      write(*,*)  'or have a minimal occupation; redo!'
      goto 10
   end if

end do

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

! Input and process orbital set

99 continue
write(*,*) 'Give orbital set'
read(*,'(a)') orbitalstring
write(12,'(a)') trim(orbitalstring)

! De-code orbital string

! Checks on orbital string

! Commas should be in position 4

do i = 1,len_trim(orbitalstring)
    if (mod(i,4).eq.0) then
       if (orbitalstring(i:i).ne.',') then
          write(*,*) 'Orbitals should be right justified and occupy three positions, redo!'
          goto 99
       end if
    end if
end do

read(unit=orbitalstring,fmt='(11(a3,x))') orbital(1:11)
norbstrings = (len_trim(orbitalstring) + 1)/4

! Determine highest n for orbital set and highest n for each symmetry

nmax = 0
do i = 1,norbstrings
!   write(*,'(a)') orbital(i)
select case(orbital(i)(3:3))
   case('s')
      lmax = 0
   case('p')
      lmax = 1
   case('d')
      lmax = 2
   case('f')
      lmax = 3
   case('g')
      lmax = 4
    case('h')
      lmax = 5
   case('i')
      lmax = 6
   case('k')
      lmax = 7
   case('l')
      lmax = 8
   case('m')
      lmax = 9
   case('n')
      lmax = 10
   case default
      write(*,*) 'Orbital quantum numbers should be in range s to n'
      stop
end select
   orbstring_l(i) = lmax

select case(orbital(i)(1:2))
   case(' 1')
      nmax = 1
   case(' 2')
      nmax = 2
   case(' 3')
      nmax = 3
   case(' 4')
      nmax = 4
   case(' 5')
      nmax = 5
   case(' 6')
      nmax = 6
   case(' 7')
      nmax = 7
   case(' 8')
      nmax = 8
   case(' 9')
      nmax = 9
   case('10')
      nmax = 10
   case('11')
      nmax = 11
   case('12')
      nmax = 12
   case('13')
      nmax = 13
   case('14')
      nmax = 14
   case('15')
      nmax = 15
   case default
      write(*,*) 'Principal quantum numbers should be <= 15'
      stop
end select
   orbstring_n(i) = nmax
end do

! Determine highest n and l for orbital set as well as spectrocopic notation

nmax = maxval(orbstring_n(1:norbstrings))
if (lmax.lt.lmaxcore) lmax = lmaxcore
lstring = decoding(lmax+1:lmax+1)

do i = 0,lmax
   nfound = 0
   do j = 1,norbstrings
      if (orbstring_l(j).eq.i) then
        nl(i) = orbstring_n(j)
        nfound = 1
      end if
   end do
   if (nfound.eq.0) nl(i) = 0
end do

if (lmax.ge.nmax) then
   write(*,*) 'Orbital quantum number should be less than n'
   stop
end if

write(*,*) 'Resulting 2*J-number? lower, higher (J=1 -> 2*J=2 etc.)'
read(*,*) jmin,jmax
write(12,*) jmin,jmax, ' ! Lower and higher 2*J'
write(*,*) 'Number of excitations '
read(*,*) nexc
write(12,*) nexc, ' ! Number of excitations '

!write(*,*)
!write(*,*) 'TESTING ORBITAL SET'
!do i = 0,lmax
!   write(*,*) 'orbital set, l, nmax',i,nl(i)
!end do
!write(*,*)

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

do j = 1,mr

! Highest principal quantum number
   write(11,*) nmax

! Highest orbital quantum number
   write(11,'(a)') lstring

! All these orbitals active
   write(11,'(a)') 'n'

! Limitations of population
   write(11,'(a)') '*'

   config = configvect(j)

! Analyze config and extract n, l and occupation

   ! Determine length of orbit substrings. Depends on number of positions
   ! that occupation and type indicator occupies.
   conflength = len(trim(config))
   k = 0
   orbstart(0) = 0
   do i = 1, conflength
      if(config(i:i).eq.')') then
         k = k + 1
         orblength(k) = i - orbstart(k-1)
         orbstart(k) = i
      end if
   end do
   norb = k  ! Number of orbit substrings in configuration

   flag(:) = 0
   do k = 1,norb
      i = 1+orbstart(k-1)
      if(config(i+4:i+4).eq.',') flag(k) = 1 ! Flag to facilitate determination if  
                                             ! occupation/type indicator occupies one/two positions
      select case(config(i:i))
         case('1')
            nr = 1
         case('2')
            nr = 2
         case('3')
            nr = 3
         case('4')
            nr = 4
         case('5')
            nr = 5
         case('6')
            nr = 6
         case('7')
            nr = 7
         case('8')
            nr = 8
         case('9')
            nr = 9
      end select

      select case(config(i+1:i+1))
         case('s')
            lr = 0
         case('p')
            lr = 1
         case('d')
            lr = 2
         case('f')
            lr = 3
         case('g')
            lr = 4
         case('h')
            lr = 5
         case('i')
            lr = 6
         case('k')
            lr = 7
         case('l')
            lr = 8
      end select

      ! If occupation number "occupies" one position
      if(flag(k).eq.1) then
         select case(config(i+3:i+3))
           case('1')
              occr = 1
           case('2')
              occr = 2
           case('3')
              occr = 3
           case('4')
              occr = 4
           case('5')
              occr = 5
           case('6')
              occr = 6
           case('7')
              occr = 7
           case('8')
              occr = 8
           case('9')
              occr = 9
          end select
      else
         select case(config(i+3:i+4))
           case(' 1')
              occr = 1
           case(' 2')
              occr = 2
           case(' 3')
              occr = 3
           case(' 4')
              occr = 4
           case(' 5')
              occr = 5
           case(' 6')
              occr = 6
           case(' 7')
              occr = 7
           case(' 8')
              occr = 8
           case(' 9')
              occr = 9
           case('10')
              occr = 10
           case('11')
              occr = 11
           case('12')
              occr = 12
           case('13')
              occr = 13
           case('14')
              occr = 14
          end select
       end if
      if (nr.gt.nmax) then
         write(*,*) 'n in config greater than nmax'
         stop
      end if

      n(k) = nr
      l(k) = lr
      occ(k) = occr

      ! Determine start position and number of positions for type indicator
      if(orblength(k).eq.7) then
         sel(k) = config(i+5:i+5)
      elseif((orblength(k).eq.8).and.(flag(k).eq.0)) then
         sel(k) = config(i+6:i+6)
      elseif((orblength(k).eq.8).and.(flag(k).eq.1)) then
         sel(k) = config(i+5:i+6)
      else
         sel(k) = config(i+6:i+7)
      end if

!CPJ  Orbitalerna i configurationen med occupation and indicators
!      write(*,*) 'n,l,occ',n(k),l(k),occ(k), sel(k)

   end do

! Generate input to jjgen from this configuration

! Highest n for reference configuration
   write(11,*) maxval(n)

! Predefined core, write only once

   if (j.eq.1) then
      if (ncore.eq.0) then
         write(11,'(a)') '*'
      else
         write(11,'(a)') 'c'
         write(11,*) ncore
      end if 
   end if

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

!   write(*,*) 'TESTING CONFIG',j

!   do k = 1, ncoreorbitals
!      write(*,*) 'coreorbitals',k,nc(k),lc(k)
!   end do

!   do k = 1, norb
!      write(*,*) 'orbitals with occupation ',k,n(k),l(k),occ(k),sel(k)
!   end do

!   do nr = 1,maxval(n)
!      do lr = 0,min(nr-1,lmax)
!         write(*,*) 'orbitals upp to nmax of configuration',nr,lr
!      end do
!   end do

!   do nr = maxval(n)+1,nmax
!      do lr = 0,min(nr-1,lmax)
!         write(*,*) 'orbitals upp to total nmax',nr,lr
!      end do
!   end do

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

   do nr = 1,maxval(n)
      do lr = 0,min(nr-1,lmax)

! Check if this orbital was previously defined as closed. If so do not write anything for this

          nclose = 0
          do k = 1,ncoreorbitals
             if ((nr.eq.nc(k)).and.(lr.eq.lc(k))) then
                nclose = 1
             end if
          end do
          if (nclose.eq.1) cycle

! Find out if orbital is closed then add it to core orbitals 
! In for the next reference configuration there will be no question for this

          do k = 1, norb
             if ((nr.eq.n(k)).and.(lr.eq.l(k))) then
                if (trim(adjustl(sel(k))).eq.'c') then 
                   ncoreorbitals = ncoreorbitals + 1
                   nc(ncoreorbitals) = n(k)
                   lc(ncoreorbitals) = l(k)
                end if
             end if
          end do

! Find out occupation and options for this orbital

          occupied = 0
          do k = 1, norb
             if ((nr.eq.n(k)).and.(lr.eq.l(k))) then
                write(11,*) occ(k)
                write(11,'(a)') trim(adjustl(sel(k)))
                occupied = 1
             end if
          end do
          if (occupied.eq.0) then
             write(11,*) 0
!CPJ             write(11,'(a)') '*'
!Correction
             if (nr.le.nl(lr)) then
                write(11,'(a)') '*'
             else
                write(11,'(a)') 'i'
             end if
!Correction
          end if

      end do
   end do

! Loop over remaining orbitals in the orbital set

   if (nmax.gt.maxval(n)) then
      do nr = maxval(n)+1,nmax
         do lr = 0,min(nr-1,lmax)
            if (nr.le.nl(lr)) then
               write(11,'(a)') '*'
            else
               write(11,'(a)') 'i'
            end if
         end do
      end do
   end if

! Write JMIN, JMAX and number of excitations

   write(11,*) jmin,jmax
   write(11,*) nexc

   if (j.ne.mr) then
      write(11,'(a)') 'y'
   else
      write(11,'(a)') '*'
   end if

end do

close(11)

end program rcsfexcitation


